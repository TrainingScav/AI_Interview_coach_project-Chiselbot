name: Discord Notify - Admin

on:
  push:
    paths:
      - "chiselbot_api_server/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare message
        id: prep
        run: |
          # ìµœê·¼ ì»¤ë°‹ ë©”ì‹œì§€
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")

          # ë¸Œëœì¹˜ ì´ë¦„ (refs/heads/ ë¶€ë¶„ ì œê±°)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (ìµœëŒ€ 5ê°œ í‘œì‹œ)
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | head -5 | sed 's/^/- /')

          # íŒŒì¼ì´ 5ê°œ ì´ìƒì´ë©´ ìš”ì•½ ì¶”ê°€
          TOTAL_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | wc -l)
          if [ $TOTAL_FILES -gt 5 ]; then
            CHANGED_FILES="${CHANGED_FILES}\n- ... (${TOTAL_FILES} files total)"
          fi

          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        run: |
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          MESSAGE="ğŸ“¢ **chiselbot_admin** í´ë”ì— push ë°œìƒ!\n\
ğŸŒ¿ ë¸Œëœì¹˜: **${{ steps.prep.outputs.branch_name }}**\n\
         ğŸ‘¤ by ${GITHUB_ACTOR}\n\
         ğŸ“ [${{ steps.prep.outputs.commit_msg }}](${COMMIT_URL})\n\n\
         **ë³€ê²½ëœ íŒŒì¼:**\n${{ steps.prep.outputs.changed_files }}"

PAYLOAD=$(jq -n --arg content "$MESSAGE" '{content: $content}')

curl -H "Content-Type: application/json" \
  -d "$PAYLOAD" \
  ${{ secrets.DISCORD_WEBHOOK_ADMIN }}
