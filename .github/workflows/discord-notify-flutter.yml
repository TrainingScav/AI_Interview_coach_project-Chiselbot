name: Discord Notify - Admin

on:
  push:
    paths:
      - "chiselbot_flutter/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare message
        id: prep
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | head -5 | sed 's/^/- /')
          TOTAL_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | wc -l)
          if [ $TOTAL_FILES -gt 5 ]; then
            CHANGED_FILES="${CHANGED_FILES}\n- ... (${TOTAL_FILES} files total)"
          fi
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        run: |
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          MESSAGE=$(cat <<EOF
  ðŸ“¢ **chiselbot_flutter** í´ë”ì— push ë°œìƒ!
ðŸŒ¿ ë¸Œëžœì¹˜: **${{ steps.prep.outputs.branch_name }}**
         ðŸ‘¤ by ${GITHUB_ACTOR}
         ðŸ“ [${{ steps.prep.outputs.commit_msg }}](${COMMIT_URL})
         
         **ë³€ê²½ëœ íŒŒì¼:**
         ${{ steps.prep.outputs.changed_files }}
         EOF
         )
PAYLOAD=$(jq -n --arg content "$MESSAGE" '{content: $content}')
curl -H "Content-Type: application/json" -d "$PAYLOAD" ${{ secrets.DISCORD_WEBHOOK_ADMIN }}
